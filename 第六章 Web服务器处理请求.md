# Web服务器处理请求

### 1. 服务器工作

1. **与客户端的不同**
   - 硬件、操作系统不同
   - Socket库的使用方式不同
   - 数据收发中连接操作不同

2. **服务器程序结构**

   1. **等待连接模块**
      - 协议栈创建套接字
      - bind程序将端口号写入套接字，listen程序等待连接
      - 客户端包到达时，accept程序创建套接字副本并连接

   2. **客户端通信模块**

      > 可以根据四种信息确定套接字：客户端IP地址、端口号、服务器IP地址、端口号

### 2. 服务器的接受操作

1. **网卡MAC模块**
   - 接受电信号，通过分离时钟信号，转换至数字信号
   - 根据数字信号FCS校验错误
   - 检查MAC头部地址是否正确

2. **IP模块**
   - 检查IP头部地址，检查是否分片并暂存
   - 根据IP头部协议号字段转给相应模块

3. **TCP模块**
   - **连接阶段**：在TCP头部控制位SYN=1，端口号空闲时，创建连接并记录发送方IP和端口号
   - **收发阶段**：根据4种信息匹配套接字，并检查序号存放至缓冲区，生成ACK号

### 3. Web服务器程序解释请求消息

1. **调用Socket库中的read读取缓冲区消息**
2. **根据访问控制规则判断访问权限**
   - 客户端IP地址
   - 客户端域名（根据IP地址查询域名）
   - 用户名和密码
3. **将虚拟目录转换至对应的实际目录，如果为程序则委托操作系统运行程序**
4. **调用Socket库中的write程序返回响应消息**

### 4. 浏览器接受响应消息并显示内容

1. **由Content-Type字段和扩展名等其他信息判断数据类型**

   > Content-Type:主类型/子类型

2. **检查Content-Encoding头部字段**
3. **显示对应的内容或调用相应的程序**

