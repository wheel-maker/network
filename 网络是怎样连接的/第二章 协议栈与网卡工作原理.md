# 协议栈与网卡的工作原理

### 1. 协议栈的工作原理

1. **协议栈的组成**

   ![](E:\计算机网络\网络是怎样连接的\imgs\tcp_ip.png)

   2. **创建套接字socket**

      :star:套接字的实体就是存放**控制信息**（**通信对象IP地址、端口号等**）的内存空间

      这个过程中协议栈会分配套接字的内存空间并存入初始状态的控制信息，并返回描述符。

   3. **连接服务器connect**

      :star:连接实际上是指通信双方交换控制信息（存储在**TCP头部**和**套接字**中），并分配数据缓冲区

      **实际工作流程**：

      	1. 客户端创建TCP头，设置SYN为1，发送序号字段初始值，委托IP模块发送
      	2. 服务器TCP模块设SYN为1，返回ACK，委托IP返回响应
      	3. 客户端修改连接状态，设置ACK并返回，连接成功

   4. **收发数据**

      TCP模块根据**MTU**、**MSS**和**时间**确定数据的**缓冲**和**拆分**，客户端和服务端**交换序号初始值**，两者通过**序号**和**ACK号**进行接受确认（设置发送缓冲区）

      ![](E:\计算机网络\网络是怎样连接的\imgs\communicate.png)

   一般使用**滑动窗口方式**管理，在**TCP头部窗口字段**中声明缓冲区大小，可以通过**合并ACK号和窗口更新包**来优化数据传输。

   5. **删除套接字**

      服务器协议栈将TCP头部FIN位设置为1并发送，客户端发送ACK号，以及FIN设为1的TCP头部，服务器返回ACK号，通信结束，随后过段时间删除套接字。

   6. **协议栈工作总流程**

      ![](E:\计算机网络\网络是怎样连接的\imgs\socket_process.png)

### 2. IP模块与网卡

 1. **网络包的基本知识**

    **包的组成：MAC头部+IP头部+TCP头部+数据块**

    （IP协议根据目标地址确定下一个IP设备，以太网协议将包传输到下一个路由器）

2. **IP模块发送包**

   1. **生成IP头部**：IP地址和协议号（TCP/UDP）

   2. **生成MAC头部**
      - **发送方MAC地址**：通过查询IP表，读取网卡对应的MAC地址
      - **接收方MAC地址**：通过APR协议由IP查询MAC地址
      - **以太类型**：IP协议（0800）、APR协议（0806）、IPv6（86DD）

   3. **网卡准备**

      ![](E:\计算机网络\网络是怎样连接的\imgs\NIC.png)

      - **MAC模块**

        - 初始化：设置MAC地址
        - 添加控制数据：报头、起始帧分界符、FCS（帧校验序列）

        - 将数字信号转换为电信号
   - **PHY(MAU)模块**：格式转换并从正负两个信号段子发送信号
      - **RJ-45接口**：信号通过RJ-45接口进入双绞线，通过接口的1号和2号针脚流入网线。

   4. **数据接受**
      
      - PHY模块将信号转换为通用格式
      - MAC模块转为数字信息，检查MAC头部并存入缓冲区
      - 发送中断请求，协议栈开始处理
      - IP模块检查IP头，出错则发送ICMP消息并对分片进行重组
      - TCP模块查找对应的套接字

### 3. UDP协议的收发操作

​		TCP只重发那些出错或者未送达的包，UDP重发所有包，对于数据量短、音视频数据均可使用UDP协议完成收发操作。